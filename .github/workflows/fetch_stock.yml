name: Fetch daily stock closes

on:
  schedule:
    - cron: "35 7 * * *"   # ë§¤ì¼ KST 16:10 (UTC+9)
  workflow_dispatch:       # í•„ìš” ì‹œ ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

permissions:
  contents: write  # ê²°ê³¼ íŒŒì¼ ì»¤ë°‹Â·í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”

jobs:
  run-fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # ðŸ”¥ ì ìˆ˜ ê³„ì‚°ìš©(_totalSZ.py, _extra_scores.py)ê¹Œì§€ ê³ ë ¤í•´ì„œ ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
            pip install requests openpyxl pandas numpy
          fi

      - name: Create secrets.json from GitHub Secrets
        run: |
          cat > secrets.json << 'EOF'
          {
            "api_key":    "${{ secrets.API_KEY }}",
            "api_secret": "${{ secrets.API_SECRET }}",
            "domain":     "${{ secrets.DOMAIN }}"
          }
          EOF

      - name: Run stock scripts (4 Excel files ì „ì²´ ì²˜ë¦¬)
        run: |
          # 1) êµ­ë‚´/í•´ì™¸ ê°œë³„ + ETF ì›ìžë£Œ(ì‹œê°€/ê³ ê°€/ì €ê°€/ì¢…ê°€/ê±°ëž˜ëŸ‰ + ì§€ìˆ˜) ìˆ˜ì§‘
          python "stock_history.py"
          # 2) 4ê°œ ì—‘ì…€ì— ëŒ€í•´ S/Z + GAP/QUANT/STD ê³„ì‚° (_totalSZ.py + _extra_scores.py ë‚´ë¶€ì—ì„œ í˜¸ì¶œ)
          python "run_all_scores.py"

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # ë³€ê²½ì‚¬í•­ì´ ìžˆì„ ë•Œë§Œ ì»¤ë°‹
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Auto-update stock values: $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            git push
          else
            echo "No changes to commit."
          fi
